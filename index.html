<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://pixijs.download/release/pixi.js"></script>
   <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>

    <script src="pfd.js"></script>
    <script src="yoke.js"></script>
</head>


<body>
    <button onclick='requestOrientationPermission();'>Test20</button>
    <!-- Button zum request der permission um die Device orientierung zu lesen -->

    <script>

        var deviceOrientation = {
            orientationPermissionGranted: 0, // Flag for Device orientation permision granted
            alpha: 0,  // Device orientation angle ALPHA
            beta: 45,   // Device orientation angle BETA
            gamma: 0,  // Device orientation angle GAMMA
        }
      
        state = {               // declare all STATE variables + initial value here
            trueAirspeed: 120,    // indicated airspeed 
            altitude: 3000,       // altitude 
            pitch: 0,             // pitch 
            roll: 0,              // roll
        }


        function requestOrientationPermission() { // Device orientierung lesen
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    alert(response);
                    if (response == 'granted') {
                        deviceOrientation.orientationPermissionGranted = 1;
                        window.addEventListener('deviceorientation', (event) => {
                            deviceOrientation.alpha = event.alpha;  // Lese winkel aus
                            deviceOrientation.beta = event.beta;  // Lese winkel aus
                            deviceOrientation.gamma = event.gamma;  // Lese winkel aus
                        })
                    }
                })
                .catch(console.error)
        }

        const app = new PIXI.Application({  // init PIXI
            antialias: true, 
            background: '#000000', 
            resizeTo: window,
            //autoResize: true,
            //resolution: devicePixelRatio 
        });
        document.body.appendChild(app.view);

      
        const yoke = yokeInput(app); // get yoke control input (yoke.js)
        
        const pfdUpdate = pfdInit(app); // PFD initialisieren und PDF update funktion (per Lambdafunktion) zurueckliefern



        // yoke pitch and roll text
        const yokeTextStyle = new PIXI.TextStyle({
            fill: "#00ff00",
            fontFamily: "\"Courier New\", Courier, monospace",
            fontSize: 36,
            fontWeight: "bold"
        });
        const yokePitchText = new PIXI.Text(yoke.pitch, yokeTextStyle);
        yokePitchText.x = 100; yokePitchText.y = 900;
        app.stage.addChild(yokePitchText);
        const yokeRollText = new PIXI.Text(yoke.roll, yokeTextStyle);
        yokeRollText.x = 500; yokeRollText.y = 900;
        app.stage.addChild(yokeRollText);
        

        var time = 0; // Simulationszeit
        
        pfdUpdate(state); // PFD update

        // Listen for animate update   
        app.ticker.add((delta) => {
            time += delta / 60; // Simulationszeitberechnung - haengt offenbar an der framerate (60 Hz???)

            if (deviceOrientation.orientationPermissionGranted || yoke.userInputActive) { // DEVICE ORIENTATION OR TOUCH CONTROL
                state.pitch = yoke.pitch; // SIMPLE MODE Yoke == state
                state.roll = yoke.roll;
            } else { // FAKE INPUT
                state.pitch = 10 * Math.sin(time / 5) // Fake pitch angle   
                state.roll = Math.sin(time / 3) / 2; // Fake bank angle          
            }

            // SIMPLE FLIGHT DYNAMIC FAKE MODEL
            state.trueAirspeed = 120 - state.pitch * 2; // je 10grd pitch down +20 kts airspeed
            state.altitude = state.altitude + state.trueAirspeed * Math.tan(state.pitch / 180 * Math.PI) * delta / 60;

            yokePitchText.text = yoke.pitch.toFixed(1);    // update Text output for Yoke Pitch
            yokeRollText.text = yoke.roll.toFixed(1);    // update Text output for Yoke Roll

            pfdUpdate(state); // PFD update
        });

    </script>
</body>

</html>