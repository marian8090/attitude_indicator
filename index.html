<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>
    <script src="pfd.js"></script>
</head>


<body>
    <button onclick='requestOrientationPermission();'>Test20</button>
    <!-- Button zum request der permission um die Device orientierung zu lesen -->

    <script>

        var deviceOrientation = {
            alpha: 0,  // Device orientation angle ALPHA
            beta: 45,   // Device orientation angle BETA
            gamma: 0,  // Device orientation angle GAMMA
        }
        //var alpha = 0;  // Device orientation angle ALPHA
        //var beta = 45;   // Device orientation angle BETA
        //var gamma = 0;  // Device orientation angle GAMMA
        orientationPermissionGranted = 0; // Flag for Device orientation permision granted

        state = {               // declare all STATE variables + initial value here
            trueAirspeed: 120,    // indicated airspeed 
            altitude: 3000,       // altitude 
            pitch: 0,             // pitch 
            roll: 0,              // roll
        }


        function requestOrientationPermission() { // Device orientierung lesen
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    alert(response);
                    if (response == 'granted') {
                        orientationPermissionGranted = 1;
                        window.addEventListener('deviceorientation', (event) => {
                            deviceOrientation.alpha = event.alpha;  // Lese winkel aus
                            deviceOrientation.beta = event.beta;  // Lese winkel aus
                            deviceOrientation.gamma = event.gamma;  // Lese winkel aus
                        })
                    }
                })
                .catch(console.error)
        }

        const app = new PIXI.Application({ antialias: true, background: '#000000', resizeTo: window });
        document.body.appendChild(app.view);

        // MOUSE CONTROL (for Desktop) 
        var touchControlActive = false;
        var touchStart = { x: 0, y: 0 };

        app.view.addEventListener("touchstart", (touchstartEvent) => {
            touchstartEvent.preventDefault();
            touchControlActive = true; // flag Touchcontrol wird benutzt
            const touches = touchstartEvent.touches;
            for (let i = 0; i < touches.length; i++) {
                touchStart = { x: touches[i].pageX, y: touches[i].pageY }
            }
        });
        app.view.addEventListener("touchmove", (touchmoveEvent) => {
            touchmoveEvent.preventDefault();
            const touches = touchmoveEvent.changedTouches;
            for (let i = 0; i < touches.length; i++) {
                //console.log(touches[i].pageX);
                //console.log(touches[i].pageY);
                gamma += (touches[i].pageX - touchStart.x) / 10;
                beta += (touches[i].pageY - touchStart.y) / 10;
                touchStart = { x: touches[i].pageX, y: touches[i].pageY }
            }
        });
        app.view.addEventListener("touchend", (touchendEvent) => {
            touchendEvent.preventDefault();
        });

        const pfdUpdate = pfdInit(app); // PFD initialisieren und PDF update funktion (per Lambdafunktion) zurueckliefern

        // draw a boresight shape
        const boresightShape = new PIXI.Graphics();
        boresightShape.beginFill(0x000000);
        boresightShape.lineStyle(2, 0xffffff, 1);
        boresightShape.moveTo(400, 400);
        boresightShape.lineTo(400 + 150, 400 + 50);
        boresightShape.lineTo(400 + 100, 400 + 50);
        boresightShape.lineTo(400, 400);
        boresightShape.beginFill(0x000000);
        boresightShape.moveTo(400, 400);
        boresightShape.lineTo(400 - 150, 400 + 50);
        boresightShape.lineTo(400 - 100, 400 + 50);
        boresightShape.lineTo(400, 400);
        boresightShape.closePath();
        boresightShape.endFill();
        app.stage.addChild(boresightShape);

        // Device orientierung als text ausgeben
        const orientationTextStyle = new PIXI.TextStyle({
            fill: "#00ff00",
            fontFamily: "\"Courier New\", Courier, monospace",
            fontSize: 36,
            fontWeight: "bold"
        });
        const alphaText = new PIXI.Text(deviceOrientation.alpha, orientationTextStyle);
        alphaText.x = 50; alphaText.y = 750;
        app.stage.addChild(alphaText);
        const betaText = new PIXI.Text(deviceOrientation.beta, orientationTextStyle);
        betaText.x = 300; betaText.y = 750;
        app.stage.addChild(betaText);
        const gammaText = new PIXI.Text(deviceOrientation.gamma, orientationTextStyle);
        gammaText.x = 550; gammaText.y = 750;
        app.stage.addChild(gammaText);

        var time = 0; // Simulationszeit
        var pitch = 5; // pitch angle
        var roll = 20; // pitch angle

        pfdUpdate(state); // PFD update

        // Listen for animate update   
        app.ticker.add((delta) => {
            time += delta / 60; // Simulationszeitberechnung - haengt offenbar an der framerate (60 Hz???)

            // SIMPLE FLIGHT DYNAMIC FAKE MODEL
            state.trueAirspeed = 120 - pitch * 2; // je 10grd pitch down +20 kts airspeed
            state.altitude = state.altitude + state.trueAirspeed * Math.tan(pitch / 180 * Math.PI) * delta / 60;

            if (orientationPermissionGranted || touchControlActive) { // DEVICE ORIENTATION CONTROL
                state.pitch = deviceOrientation.beta - 45; // 45grd schraeges phone entspricht Pitch=0
                state.roll = deviceOrientation.gamma;
            } else { // TOUCH CONTROL
                state.pitch = 10 * Math.sin(time / 5) // Fake pitch angle   
                state.roll = Math.sin(time / 3) / 2; // Fake bank angle          
            }

            alphaText.text = deviceOrientation.alpha.toFixed(2); // update Text output for orientation angle\
            betaText.text = deviceOrientation.beta.toFixed(2); // update Text output for orientation angle
            gammaText.text = deviceOrientation.gamma.toFixed(2); // update Text output for orientation angle

            pfdUpdate(state); // PFD update
        });

    </script>
</body>

</html>