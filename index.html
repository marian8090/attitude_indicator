<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://pixijs.download/release/pixi.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>

    <script src="pfd.js"></script>
    <script src="yoke.js"></script>
</head>


<body>
    <button onclick='requestOrientationPermission();'>Test20</button>
    <!-- Button zum request der permission um die Device orientierung zu lesen -->

    <script>

        var deviceOrientation = {
            orientationPermissionGranted: 0, // Flag for Device orientation permision granted
            alpha: 0,  // Device orientation angle ALPHA
            beta: 45,   // Device orientation angle BETA
            gamma: 0,  // Device orientation angle GAMMA
        }
      
        state = {               // declare all STATE variables + initial value here
            trueAirspeed: 120,    // indicated airspeed 
            altitude: 3000,       // altitude 
            pitch: 0,             // pitch 
            roll: 0,              // roll
        }


        function requestOrientationPermission() { // Device orientierung lesen
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    alert(response);
                    if (response == 'granted') {
                        deviceOrientation.orientationPermissionGranted = 1;
                        window.addEventListener('deviceorientation', (event) => {
                            deviceOrientation.alpha = event.alpha;  // Lese winkel aus
                            deviceOrientation.beta = event.beta;  // Lese winkel aus
                            deviceOrientation.gamma = event.gamma;  // Lese winkel aus
                        })
                    }
                })
                .catch(console.error)
        }

        const app = new PIXI.Application({ antialias: true, background: '#000000', resizeTo: window }); // init PIXI
        document.body.appendChild(app.view);

        // TOUCH CONTROL (for desktop and phone) 
        const yoke = yokeInput(app);
        // yoke.pitch, yoke.roll

        const pfdUpdate = pfdInit(app); // PFD initialisieren und PDF update funktion (per Lambdafunktion) zurueckliefern



        // Device orientierung als text ausgeben
        const orientationTextStyle = new PIXI.TextStyle({
            fill: "#00ff00",
            fontFamily: "\"Courier New\", Courier, monospace",
            fontSize: 36,
            fontWeight: "bold"
        });
        const alphaText = new PIXI.Text(deviceOrientation.alpha, orientationTextStyle);
        alphaText.x = 50; alphaText.y = 750;
        app.stage.addChild(alphaText);
        const betaText = new PIXI.Text(deviceOrientation.beta, orientationTextStyle);
        betaText.x = 300; betaText.y = 750;
        app.stage.addChild(betaText);
        const gammaText = new PIXI.Text(deviceOrientation.gamma, orientationTextStyle);
        gammaText.x = 550; gammaText.y = 750;
        app.stage.addChild(gammaText);

        var time = 0; // Simulationszeit
        
        pfdUpdate(state); // PFD update

        // Listen for animate update   
        app.ticker.add((delta) => {
            time += delta / 60; // Simulationszeitberechnung - haengt offenbar an der framerate (60 Hz???)

            if (deviceOrientation.orientationPermissionGranted || yoke.userInputActive) { // DEVICE ORIENTATION OR TOUCH CONTROL
                state.pitch = yoke.pitch; // SIMPLE MODE Yoke == state
                state.roll = yoke.roll;
            } else { // FAKE INPUT
                state.pitch = 10 * Math.sin(time / 5) // Fake pitch angle   
                state.roll = Math.sin(time / 3) / 2; // Fake bank angle          
            }

            // SIMPLE FLIGHT DYNAMIC FAKE MODEL
            state.trueAirspeed = 120 - state.pitch * 2; // je 10grd pitch down +20 kts airspeed
            state.altitude = state.altitude + state.trueAirspeed * Math.tan(state.pitch / 180 * Math.PI) * delta / 60;

            alphaText.text = deviceOrientation.alpha.toFixed(2);    // update Text output for orientation angle
            betaText.text = deviceOrientation.beta.toFixed(2);      // update Text output for orientation angle
            gammaText.text = deviceOrientation.gamma.toFixed(2);    // update Text output for orientation angle

            pfdUpdate(state); // PFD update
        });

    </script>
</body>

</html>